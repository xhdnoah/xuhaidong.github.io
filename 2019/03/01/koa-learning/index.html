<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Noah Xu"><title>koa-learning · Electronic Moon</title><meta name="description" content="1.1 架设 HTTP 服务1234567// demos/01.jsconst Koa = require(&amp;apos;koa&amp;apos;)const app = new Koa()app.listen(3000)// sh$ node demos/01.js
1.2 Context 对象koa "><meta name="keywords" content=""><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title"></a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">电子月亮</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/tags">Tags</a></li><li class="soc"><a href="https://github.com/xhdnoah" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://twitter.com/xhdnoah" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter">&nbsp;</i></a><a href="http://xhdnoah.github.io/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2019&nbsp;<a target="_blank" href="http://xhdnoah.github.io" rel="noopener noreferrer">Noah Xu</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>koa-learning</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2019-03-01</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/Node-js/" title="Node.js" class="a-tag">Node.js</a><span>&nbsp;</span></span></p><p class="post-abstract"><h2 id="1-1-架设-HTTP-服务"><a href="#1-1-架设-HTTP-服务" class="headerlink" title="1.1 架设 HTTP 服务"></a>1.1 架设 HTTP 服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// demos/01.js</span><br><span class="line">const Koa = require(&apos;koa&apos;)</span><br><span class="line">const app = new Koa()</span><br><span class="line">app.listen(3000)</span><br><span class="line"></span><br><span class="line">// sh</span><br><span class="line">$ node demos/01.js</span><br></pre></td></tr></table></figure>
<h2 id="1-2-Context-对象"><a href="#1-2-Context-对象" class="headerlink" title="1.2 Context 对象"></a>1.2 Context 对象</h2><p>koa 提供 Context 对象，表示一次对话的上下文（包括 HTTP 请求和 HTTP 回复），通过加工这个对象，就可以控制返回给用户的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// demos/02.js</span><br><span class="line">const Koa = require(&apos;koa&apos;)</span><br><span class="line">const app = new Koa()</span><br><span class="line">// 用于设置 ctx.response.body 的函数</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.body = &apos;Hello World&apos;</span><br><span class="line">&#125;</span><br><span class="line">// 加载 main 函数</span><br><span class="line">app.use(main)</span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure>
<h2 id="1-3-HTTP-Response-类型"><a href="#1-3-HTTP-Response-类型" class="headerlink" title="1.3 HTTP Response 类型"></a>1.3 HTTP Response 类型</h2><p>Koa 默认返回类型<code>text/plain</code>，如果想返回其他类型，可以先<code>ctx.request.accepts</code>判断，再使用 <code>ctx.response.type</code> 指定返回类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// demos/03.js</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    if (ctx.request.accepts(&apos;xml&apos;))&#123;</span><br><span class="line">        ctx.response.type = &apos;xml&apos;</span><br><span class="line">        ctx.response.body = &apos;&lt;data&gt;Hello World&lt;/data&gt;&apos;</span><br><span class="line">    &#125; else if (ctx.request.request.accepts(&apos;json&apos;))&#123;</span><br><span class="line">        ctx.response.type = &apos;json&apos;</span><br><span class="line">        ctx.response.body = &#123; data: &apos;Hello World&apos; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-网页模板"><a href="#1-4-网页模板" class="headerlink" title="1.4 网页模板"></a>1.4 网页模板</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// demos/04.js</span><br><span class="line">const fs = require(&apos;fs&apos;)</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.type = &apos;html&apos;</span><br><span class="line">    ctx.response.body = fs.createReadSteam(&apos;./demos/template.html&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-1-原生路由"><a href="#2-1-原生路由" class="headerlink" title="2.1 原生路由"></a>2.1 原生路由</h2><p>通过<code>ctx.request.path</code>可获取用户请求的路径，实现简单路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    if (ctx.request.path !== &apos;/&apos;)&#123;</span><br><span class="line">        ctx.response.type = &apos;html&apos;</span><br><span class="line">        ctx,response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index Page&lt;/a&gt;&apos;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ctx.response.body = &apos;Hello World&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-koa-route-模块"><a href="#2-2-koa-route-模块" class="headerlink" title="2.2 koa-route 模块"></a>2.2 koa-route 模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const route = require(&apos;koa-route&apos;)</span><br><span class="line">const about = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.type = &apos;html&apos;</span><br><span class="line">    ctx.response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index Page&lt;/a&gt;&apos;</span><br><span class="line">&#125;</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.body = &apos;Hello World&apos;</span><br><span class="line">&#125;</span><br><span class="line">app.use(route.get(&apos;/&apos;, main))</span><br><span class="line">app.use(route.get(&apos;/about&apos;, about))</span><br></pre></td></tr></table></figure>
<h2 id="2-3-静态资源"><a href="#2-3-静态资源" class="headerlink" title="2.3 静态资源"></a>2.3 静态资源</h2><p><code>koa-static</code> 模块封装了静态资源（图片、字体、样式表、脚本）这部分的请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const serve = require(&apos;koa-static&apos;)</span><br><span class="line">const main = serve(path.join(__dirname))</span><br><span class="line">app.use(main)</span><br></pre></td></tr></table></figure>
<p><code>koa-send</code>是 <code>koa-static</code> 的基础</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const send = require(&apos;koa-send&apos;)</span><br><span class="line"></span><br><span class="line">// 针对某个路径下的文件获取</span><br><span class="line">router.get(&apos;file&apos;,async ctx =&gt; &#123;</span><br><span class="line">    await send(ctx, ctx.query.path, &#123;</span><br><span class="line">        root: path.resolve(__dirname, &apos;./public&apos;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 针对某个文件的获取</span><br><span class="line">router.get(&apos;index&apos;, async ctx =&gt; &#123;</span><br><span class="line">    await send(ctx, &apos;./public/index.log&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>使用<code>/file?path=XXX</code>就可以很轻易的访问到<code>public</code>下的文件，访问<code>/index</code>就可以拿到<code>/public/index.log</code>文件的内容。</p>
<h2 id="2-4-重定向"><a href="#2-4-重定向" class="headerlink" title="2.4 重定向"></a>2.4 重定向</h2><p><code>ctx.response.redirect()</code> 方法可发出一个 302 跳转，将用户导向另一路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const redirect = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.redirect(&apos;/&apos;)</span><br><span class="line">    ctx.response.body - &apos;&lt;a href=&quot;/&quot;&gt;Index Page&lt;/a&gt;&apos;</span><br><span class="line">&#125;</span><br><span class="line">app.use(route.get(&apos;/redirect&apos;, redirect))</span><br></pre></td></tr></table></figure>
<p>访问 <code>http://127.0.0.1:3000/redirect</code> ，浏览器会将用户导向根路由。</p>
<h2 id="3-1-中间件之-Logger-功能"><a href="#3-1-中间件之-Logger-功能" class="headerlink" title="3.1 中间件之 Logger 功能"></a>3.1 中间件之 Logger 功能</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    console.log(`$&#123;Date.now()&#125; $&#123;ctx.request.method&#125; $&#123;ctx.request.url&#125;`)</span><br><span class="line">    ctx.response.body = &apos;Hello World&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问 <code>http://127.0.0.1:3000</code> ，命令行就会输出日志。</p>
<h2 id="3-2-中间件的概念"><a href="#3-2-中间件的概念" class="headerlink" title="3.2 中间件的概念"></a>3.2 中间件的概念</h2><p>Logger 功能可从 main 函数中拆分成独立函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const logger = (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(`$&#123;Date.now()&#125; $&#123;ctx.request.method&#125; $&#123;ctx.request.url&#125;`)</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line">app.use(logger)</span><br></pre></td></tr></table></figure>
<p><code>logger</code>函数就叫做 middleware 中间件，它处于 HTTP Request 和 HTTP Response 中间，<code>app.use()</code>用于加载中间件。</p>
<p>中间件默认接受两个参数，Context 对象 和 next 函数，只要调用 <code>next</code> 函数，就可以把执行权转交给下个中间件。</p>
<h2 id="3-3-中间件栈"><a href="#3-3-中间件栈" class="headerlink" title="3.3 中间件栈"></a>3.3 中间件栈</h2><p>中间件栈 middle stack，以“先进后出”的顺序执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const one = (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(&apos;&gt;&gt; one&apos;)</span><br><span class="line">    next()</span><br><span class="line">    console.log(&apos;&lt;&lt; one&apos;)</span><br><span class="line">&#125;</span><br><span class="line">const two = (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(&apos;&gt;&gt; two&apos;)</span><br><span class="line">    next()</span><br><span class="line">    console.log(&apos;&lt;&lt; two&apos;)</span><br><span class="line">&#125;</span><br><span class="line">const three = (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(&apos;&gt;&gt; three&apos;)</span><br><span class="line">    next()</span><br><span class="line">    console.log(&apos;&lt;&lt; three&apos;)</span><br><span class="line">&#125;</span><br><span class="line">app.use(one)</span><br><span class="line">app.use(two)</span><br><span class="line">app.use(three)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// sh</span><br><span class="line">&gt;&gt; one</span><br><span class="line">&gt;&gt; two</span><br><span class="line">&gt;&gt; three</span><br><span class="line">&lt;&lt; three</span><br><span class="line">&lt;&lt; two</span><br><span class="line">&lt;&lt; one</span><br></pre></td></tr></table></figure>
<p>如果中间件内部没有调用<code>next</code>函数，那么执行权就不会传递下去</p>
<h2 id="3-4-异步中间件"><a href="#3-4-异步中间件" class="headerlink" title="3.4 异步中间件"></a>3.4 异步中间件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs.promised&apos;)</span><br><span class="line">const Koa = require(&apos;koa&apos;)</span><br><span class="line">const app = new Koa()</span><br><span class="line"></span><br><span class="line">const main = async function (ctx, next) &#123;</span><br><span class="line">    ctx.response.type = &apos;html&apos;</span><br><span class="line">    ctx.response.body = await fs.readFile(&apos;./demos/template.html&apos;,&apos;utf8&apos;)</span><br><span class="line">&#125;</span><br><span class="line">app.use(main)</span><br><span class="line">app.listen(3000)</span><br></pre></td></tr></table></figure>
<p><code>fs.readFile</code>是一个异步操作，必须写成<code>await fs.readFile()</code>，中间件必须写成 async 函数。</p>
<h2 id="3-5-中间件的合成"><a href="#3-5-中间件的合成" class="headerlink" title="3.5 中间件的合成"></a>3.5 中间件的合成</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const compose = require(&apos;koa-compose&apos;)</span><br><span class="line">const logger = (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(`$&#123;Date.now()&#125; $(ctx.request.method) $&#123;ctx.request.url&#125;`)</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.body = &apos;Hello World&apos;</span><br><span class="line">&#125;</span><br><span class="line">const middleware = compose([logger, main])</span><br><span class="line">app.use(middlewares)</span><br></pre></td></tr></table></figure>
<h1 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h1><h2 id="4-1-500-错误"><a href="#4-1-500-错误" class="headerlink" title="4.1 500 错误"></a>4.1 500 错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.throw(500)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-404-错误"><a href="#4-2-404-错误" class="headerlink" title="4.2 404 错误"></a>4.2 404 错误</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.response.status = 404</span><br><span class="line">    ctx.response.body = &apos;Page Not Found&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-处理错误的中间件"><a href="#4-3-处理错误的中间件" class="headerlink" title="4.3 处理错误的中间件"></a>4.3 处理错误的中间件</h2><p>为每个中间件都写<code>try...catch</code>太麻烦，可以让最外层的中间件，负责所有中间件的错误处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const handler = async (ctx, next) =&gt; &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        await next()</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">        ctx.response.status = err.statusCode || err.status || 500</span><br><span class="line">        ctx.response.body = &#123;</span><br><span class="line">            message: err.message</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.throw(500)</span><br><span class="line">&#125;</span><br><span class="line">app.use(handler)</span><br><span class="line">app.use(main)</span><br></pre></td></tr></table></figure>
<h2 id="4-4-error-事件的监听"><a href="#4-4-error-事件的监听" class="headerlink" title="4.4 error 事件的监听"></a>4.4 error 事件的监听</h2><p>运行过程一旦出错，Koa 会触发一个<code>error</code>事件，监听这个事情也可以处理错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.throw(500)</span><br><span class="line">&#125;</span><br><span class="line">app.on(&apos;error&apos;,(err, ctx) =&gt; &#123;</span><br><span class="line">    console.error(&apos;server error&apos;, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5-释放-error-事件"><a href="#4-5-释放-error-事件" class="headerlink" title="4.5 释放 error 事件"></a>4.5 释放 error 事件</h2><p>如果错误被<code>try...catch</code>捕获，就不会触发<code>error</code>事件，必须调用<code>ctx.app.emit()</code>，手动释放<code>error</code>事件让监听函数监听到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const handler = async (ctx, next) =&gt; &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        await next()</span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">        ctx.response.status = err.statusCode || err.status || 500</span><br><span class="line">        ctx.response.type = &apos;html&apos;</span><br><span class="line">        ctx.response.body = &apos;&lt;p&gt;Something wrong, please contact asministrator.&lt;/p&gt;&apos;</span><br><span class="line">        ctx.app.emit(&apos;error&apos;, err, ctx)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">const main = ctx =&gt; &#123;</span><br><span class="line">    ctx.throw(500)</span><br><span class="line">&#125;</span><br><span class="line">app.on(&apos;error&apos;, function(err) &#123;</span><br><span class="line">    console.log(&apos;logging error&apos;,err.message)</span><br><span class="line">    console.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>main</code> 函数抛出错误，被<code>handler</code>函数捕获，<code>catch</code> 代码块里使用 <code>ctx.app.emit()</code> 手动释放 <code>error</code> 事件，才能让监听函数监听到</p>
<h1 id="Web-App"><a href="#Web-App" class="headerlink" title="Web App"></a>Web App</h1><h2 id="5-1-Cookies"><a href="#5-1-Cookies" class="headerlink" title="5.1 Cookies"></a>5.1 Cookies</h2><p><code>ctx.cookies</code>用来读写 Cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const main = function(ctx) =&gt; &#123;</span><br><span class="line">    const n = Number(ctx.cookies.get(&apos;view&apos;) || 0) + 1</span><br><span class="line">    ctx.cookies.set(&apos;view&apos;, n)</span><br><span class="line">    ctx.response.body = n + &apos;views&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问 <code>http://127.0.0.1:3000</code> ，你会看到<code>1 views</code>。刷新一次页面，就变成了<code>2 views</code>。再刷新，每次都会计数增加 1。</p>
<h2 id="5-2-表单"><a href="#5-2-表单" class="headerlink" title="5.2 表单"></a>5.2 表单</h2><p>Web 应用离不开处理表单，表单本质上是 POST 方法发送到服务器的键值对。<code>koa-body</code> 模块可以用来从 POST 请求的数据体里提取键值对</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const koaBody = require(&apos;koa-body&apos;)</span><br><span class="line">const main = async function(ctx) &#123;</span><br><span class="line">    const body = ctx.require.body</span><br><span class="line">    if(!body.name) ctx.throw(400, &apos;.name required&apos;)</span><br><span class="line">    ctx.body = &#123; name: body.name &#125;</span><br><span class="line">&#125;</span><br><span class="line">app.use(koaBody())</span><br></pre></td></tr></table></figure>
<p>使用 POST 方法向服务器发送一个键值对，会被正确解析。如果发送的数据不正确，就会收到错误提示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// sh</span><br><span class="line">$ curl -X POST --data &quot;name=Noah&quot; 127.0.0.1:3000</span><br><span class="line">&#123;&quot;name&quot;:&quot;Noah&quot;&#125;</span><br><span class="line">$ curl -X POST --data &quot;name&quot; 127.0.0.1:3000</span><br><span class="line">name required</span><br></pre></td></tr></table></figure>
<h2 id="2-3-文件上传"><a href="#2-3-文件上传" class="headerlink" title="2.3 文件上传"></a>2.3 文件上传</h2><p><code>koa-body</code>模块还可以用来处理文件上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const os = require(&apos;os&apos;)</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const koaBody = require(&apos;koa-body&apos;)</span><br><span class="line">const main = async function(ctx) &#123;</span><br><span class="line">    const tmpdir = os.tmpdir()</span><br><span class="line">    const filePaths = []</span><br><span class="line">    const files = ctx.request.body.files || &#123;&#125;</span><br><span class="line">    for ( let key in files )&#123;</span><br><span class="line">        const file = files[key]</span><br><span class="line">        const filePath = path.join(tmdir, file.name)</span><br><span class="line">        const reader = fs.createReadStream(file.path)</span><br><span class="line">        const writer = fs.createWriteStream(filePath)</span><br><span class="line">        reader.pipe(writer)</span><br><span class="line">        filePath.push(filePath)</span><br><span class="line">    &#125;</span><br><span class="line">ctx.body = filePaths</span><br><span class="line">&#125;</span><br><span class="line">app.use(koaBody(&#123; multipart: true &#125;))</span><br></pre></td></tr></table></figure>
<p>上传一个文件。注意，<code>/path/to/file</code>要更换为真实的文件路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl --form upload=@/path/to/file http://127/0.0.1:3000</span><br><span class="line">[&quot;/tmp/file&quot;]</span><br></pre></td></tr></table></figure>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=http://xhdnoah.github.io/2019/03/01/koa-learning/%20Electronic Moon%20koa-learning" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2019/03/06/axios/" title="axios-learning"><i class="fa fa-angle-double-left"></i>&nbsp;Previous post: axios-learning</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2018/12/26/eslint-format/" title="ESlint 自动格式化正确姿势">Next post: ESlint 自动格式化正确姿势&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><div id="lv-container" data-id="city" data-uid="livere_data_uid"><script type="text/javascript">(function (d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') {
        return;
    }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script><noscript> Please activate JavaScript for write a comment in LiveRe</noscript></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2019&nbsp;<a target="_blank" href="http://xhdnoah.github.io" rel="noopener noreferrer">Noah Xu</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>