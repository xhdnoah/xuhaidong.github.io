<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Noah Xu"><title>ä¸ƒå¤©å­¦ä¼š NodeJs Â· Electronic Moon</title><meta name="description" content="æ¯ä¸€ç§è§£æå™¨éƒ½æ˜¯ä¸€ä¸ªè¿è¡Œç¯å¢ƒï¼Œä¸ä½†å…è®¸ JS å®šä¹‰å„ç§æ•°æ®ç»“æ„ï¼Œè¿›è¡Œå„ç§è¿ç®—ï¼Œè¿˜å…è®¸ JS ä½¿ç”¨è¿è¡Œç¯å¢ƒæä¾›çš„å†…ç½®å¯¹è±¡å’Œæ–¹æ³•ã€‚è¿è¡Œåœ¨æµè§ˆå™¨çš„ JS çš„ç”¨é€”æ˜¯æ“ä½œ DOMï¼Œæµè§ˆå™¨å°±æä¾›äº†document ç­‰å†…ç½®å¯¹è±¡ã€‚è¿è¡Œåœ¨ NodeJs ä¸­çš„ JS çš„ç”¨é€”æ˜¯æ“ä½œç£ç›˜æ–‡ä»¶æˆ–æ­å»º HTTP æœåŠ¡å™¨ï¼ŒNod"><meta name="keywords" content><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style-dark.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title"></a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">Electronic Moon</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">é¦–é¡µ</a></li><li><a href="/archives">å½’æ¡£</a></li><li><a href="/tags">æ ‡ç­¾</a></li><li class="soc"><a href="https://github.com/xhdnoah" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="http://xhdnoah.github.io/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2019&nbsp;<a target="_blank" href="http://xhdnoah.github.io" rel="noopener noreferrer">Noah Xu</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>ä¸ƒå¤©å­¦ä¼š NodeJs</a></p><p class="post-meta"><span class="date meta-item">å‘å¸ƒäº&nbsp;2018-11-05</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/Node-js/" title="Node.js" class="a-tag">Node.js</a><span>&nbsp;</span></span></p><p class="post-abstract"></p><p>æ¯ä¸€ç§è§£æå™¨éƒ½æ˜¯ä¸€ä¸ªè¿è¡Œç¯å¢ƒï¼Œä¸ä½†å…è®¸ JS å®šä¹‰å„ç§æ•°æ®ç»“æ„ï¼Œè¿›è¡Œå„ç§è¿ç®—ï¼Œè¿˜å…è®¸ JS ä½¿ç”¨è¿è¡Œç¯å¢ƒæä¾›çš„å†…ç½®å¯¹è±¡å’Œæ–¹æ³•ã€‚è¿è¡Œåœ¨æµè§ˆå™¨çš„ JS çš„ç”¨é€”æ˜¯æ“ä½œ DOMï¼Œæµè§ˆå™¨å°±æä¾›äº†<code>document</code> ç­‰å†…ç½®å¯¹è±¡ã€‚è¿è¡Œåœ¨ NodeJs ä¸­çš„ JS çš„ç”¨é€”æ˜¯æ“ä½œç£ç›˜æ–‡ä»¶æˆ–æ­å»º HTTP æœåŠ¡å™¨ï¼ŒNodeJs å°±æä¾› <code>fs</code>,<code>http</code> ç­‰å†…ç½®å¯¹è±¡ã€‚</p>
<h2 id="æ¨¡å—"><a href="#æ¨¡å—" class="headerlink" title="æ¨¡å—"></a>æ¨¡å—</h2><p>åœ¨ç¼–å†™æ¯ä¸ªæ¨¡å—æ—¶ï¼Œéƒ½æœ‰ <code>require</code>,<code>exports</code>,<code>module</code> ä¸‰ä¸ªé¢„å…ˆå®šä¹‰å¥½çš„å˜é‡å¯ä¾›ä½¿ç”¨ã€‚</p>
<h3 id="require"><a href="#require" class="headerlink" title="require"></a>require</h3><pre><code>var foo1 = require(â€˜./fooâ€™);
var foo2 = require(â€˜./foo.jsâ€™);
var foo3 = require(â€˜home/user/fooâ€™);
var foo4 = require(â€˜home/user/foo.jsâ€™);

//foo1~4ä¸­ä¿å­˜ç€åŒä¸€ä¸ªæ¨¡å—çš„å¯¼å‡ºå¯¹è±¡
</code></pre><p>åŠ è½½å’Œä½¿ç”¨ä¸€ä¸ª JSON æ–‡ä»¶ï¼š<br><code>var data = require(â€˜./data.jsonâ€™)</code></p>
<h3 id="exports"><a href="#exports" class="headerlink" title="exports"></a>exports</h3><p><code>exports</code>å¯¹è±¡æ˜¯å½“å‰æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ï¼Œç”¨äºå¯¼å‡ºæ¨¡å—å…¬æœ‰æ–¹æ³•å’Œå±æ€§</p>
<pre><code>//å¯¼å‡ºä¸€ä¸ªå…¬æœ‰æ–¹æ³•
 exports.hello = function(){
    console.log(â€˜Hello Worldâ€™);
}
</code></pre><h3 id="module"><a href="#module" class="headerlink" title="module"></a>module</h3><p>é€šè¿‡<code>module</code>å¯¹è±¡å¯ä»¥è®¿é—®å½“å‰æ¨¡å—çš„ç›¸å…³ä¿¡æ¯ï¼Œæœ€å¸¸è§çš„ç”¨é€”æ˜¯æ›¿æ¢å½“å‰æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡:</p>
<pre><code>module.exports = function(){
    console.log(â€˜Hello World!â€™);
}
</code></pre><h3 id="æ¨¡å—åˆå§‹åŒ–"><a href="#æ¨¡å—åˆå§‹åŒ–" class="headerlink" title="æ¨¡å—åˆå§‹åŒ–"></a>æ¨¡å—åˆå§‹åŒ–</h3><p>æ¨¡å—ä¸­çš„ JS ä»£ç ä»…åœ¨ç¬¬ä¸€æ¬¡è¢«ä½¿ç”¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆå§‹åŒ–æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ã€‚</p>
<h3 id="ä¸»æ¨¡å—"><a href="#ä¸»æ¨¡å—" class="headerlink" title="ä¸»æ¨¡å—"></a>ä¸»æ¨¡å—</h3><pre><code>- /home/user/hello/
    - util/
        counter.js
    main.js
</code></pre><pre><code>//counter.js æ¨¡å—å†…éƒ¨å®šä¹‰ç§æœ‰å˜é‡i,åœ¨exportså¯¹è±¡å¯¼å‡ºå…¬æœ‰æ–¹æ³•count
var i = 0;
function count(){
    return ++i;
}
exports.count = count;
</code></pre><pre><code>//ä¸»æ¨¡å— main.js
var counter1 = require(â€˜./util/counterâ€™);
var counter2 = require(â€˜./util/counterâ€™);

console.log(counter1.counter());
console.log(counter2.counter());
console.log(counter3.counter());
</code></pre><pre><code>$ node main.js
//outputs
1
2
3
</code></pre><h2 id="ä»£ç ç»„ç»‡å’Œéƒ¨ç½²"><a href="#ä»£ç ç»„ç»‡å’Œéƒ¨ç½²" class="headerlink" title="ä»£ç ç»„ç»‡å’Œéƒ¨ç½²"></a>ä»£ç ç»„ç»‡å’Œéƒ¨ç½²</h2><h3 id="æ¨¡å—è·¯å¾„è§£æè§„åˆ™"><a href="#æ¨¡å—è·¯å¾„è§£æè§„åˆ™" class="headerlink" title="æ¨¡å—è·¯å¾„è§£æè§„åˆ™"></a>æ¨¡å—è·¯å¾„è§£æè§„åˆ™</h3><p><code>require</code> å‡½æ•°æ”¯æŒå¼ºè€¦åˆçš„ç»å¯¹è·¯å¾„<code>/</code>å’Œç›¸å¯¹è·¯å¾„<code>/</code>ï¼Œä¹Ÿæ”¯æŒç¬¬ä¸‰ç§å½¢å¼è·¯å¾„<code>foo/bar</code>ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹è§„åˆ™è§£æè·¯å¾„ï¼Œç›´åˆ°æ‰¾åˆ°æ¨¡å—ä½ç½®ã€‚</p>
<ol>
<li>å†…ç½®æ¨¡å—<code>require(â€˜fsâ€™)</code></li>
<li>node_modules ç›®å½•</li>
<li>NODE_PATH ç¯å¢ƒå˜é‡</li>
</ol>
<h3 id="åŒ…-package"><a href="#åŒ…-package" class="headerlink" title="åŒ…(package)"></a>åŒ…(package)</h3><p>åœ¨ç»„æˆä¸€ä¸ªåŒ…çš„æ‰€æœ‰å­æ¨¡å—ä¸­ï¼Œéœ€è¦ä¸€ä¸ªå…¥å£æ¨¡å—ï¼Œå…¥å£æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡è¢«ä½œä¸ºåŒ…çš„å¯¼å‡ºå¯¹è±¡ã€‚</p>
<pre><code>- /home/user/lib/
    - cat/
        head.js
        body.js
        main.js
</code></pre><pre><code>//å…¥å£æ¨¡å— main.js
var head = require(â€˜./headâ€™);
var body = require(â€˜./bodyâ€™);

exports.create = function(name){
    return {
        name: name,
        head: head.create(),
        body: body.create()
    };
};
</code></pre><p><em>index.js</em><br>å½“æ¨¡å—æ–‡ä»¶åä¸º<code>index.js</code>ï¼ŒåŠ è½½æ¨¡å—æ—¶å¯ä»¥ä½¿ç”¨æ¨¡å—æ‰€åœ¨ç›®å½•çš„è·¯å¾„ä»£æ›¿æ¨¡å—æ–‡ä»¶è·¯å¾„</p>
<pre><code>var cat = require(â€˜/home/user/lib/catâ€™);
// is equivalent to
var cat = require(â€˜/home/user/lib/cat/indexâ€™)
</code></pre><p>è¿™æ ·å°±åªéœ€æŠŠåŒ…ç›®å½•è·¯å¾„ä¼ é€’ç»™<code>require</code>å‡½æ•°ï¼Œè®©åŒ…ä½¿ç”¨èµ·æ¥æ›´åƒå•ä¸ªç›®å½•ã€‚</p>
<p><em>package.json</em></p>
<pre><code>- home/user/lib/
    - cat/
        + doc/
        - lib/
            head.js
            body.js
            main.js
        + tests/
        package.json
</code></pre><pre><code>// package.json
{
    â€œnameâ€: â€œcatâ€,
    â€œmainâ€: â€œ./lib/main.jsâ€
}
</code></pre><p>å¦‚æ­¤å°±åŒæ ·å¯ä»¥ç”¨<code>require(â€˜/home/user/lib/catâ€™)</code>æ–¹å¼åŠ è½½æ¨¡å—ï¼ŒNodeJs æ ¹æ®åŒ…ç›®å½•ä¸‹<code>package.json</code>æ‰¾åˆ°å…¥å£æ¨¡å—ä½ç½®ã€‚</p>
<h3 id="å·¥ç¨‹ç›®å½•"><a href="#å·¥ç¨‹ç›®å½•" class="headerlink" title="å·¥ç¨‹ç›®å½•"></a>å·¥ç¨‹ç›®å½•</h3><pre><code>- /home/user/workspace/node-echo/    # å·¥ç¨‹ç›®å½•
    - bin/    #å‘½ä»¤è¡Œç›¸å…³ä»£ç 
        node-echo
    + doc/    #æ–‡æ¡£
    - lib/    #APIç›¸å…³ä»£ç 
        echo.js
    - node_modules/    #ç¬¬ä¸‰æ–¹åŒ…
        + argv/
    + tests/    #æµ‹è¯•ç”¨ä¾‹
    package.json    #å…ƒæ•°æ®æ–‡ä»¶
    README.MD
</code></pre><pre><code>/* bin/node-echo */
var argv = require(&#39;argv&#39;),
    echo = require(&#39;../lib/echo&#39;);
console.log(echo(argv.join(&#39; &#39;)));

/* lib/echo.js */
module.exports = function (message) {
    return message;
};

/* package.json */
{
    &quot;name&quot;: &quot;node-echo&quot;,
    &quot;main&quot;: &quot;./lib/echo.js&quot;
}
</code></pre><h1 id="æ–‡ä»¶æ“ä½œ"><a href="#æ–‡ä»¶æ“ä½œ" class="headerlink" title="æ–‡ä»¶æ“ä½œ"></a>æ–‡ä»¶æ“ä½œ</h1><h2 id="å¼€é—¨çº¢"><a href="#å¼€é—¨çº¢" class="headerlink" title="å¼€é—¨çº¢"></a>å¼€é—¨çº¢</h2><h3 id="å°æ–‡ä»¶æ‹·è´"><a href="#å°æ–‡ä»¶æ‹·è´" class="headerlink" title="å°æ–‡ä»¶æ‹·è´"></a>å°æ–‡ä»¶æ‹·è´</h3><pre><code>var fs = require(â€˜fsâ€™);
function copy(src, dst){
    fs.writeFileSync(dst, fs.readFileSync(src));
}
function main(argv){
    copy(argv[0],argv[1]);
}
main(process.argv.slice(2));
</code></pre><p><code>process</code>æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯é€šè¿‡<code>process.argv</code>è·å¾—å‘½ä»¤è¡Œå‚æ•°ï¼Œ<code>argv[0]</code>å›ºå®šç­‰äº NodeJs æ‰§è¡Œç¨‹åºçš„ç»å¯¹è·¯å¾„ï¼Œ<code>argv[1]</code>å›ºå®šç­‰äºä¸»æ¨¡å—çš„ç»å¯¹è·¯å¾„ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ä»<code>argv[2]</code>å¼€å§‹ã€‚</p>
<h3 id="å¤§æ–‡ä»¶æ‹·è´"><a href="#å¤§æ–‡ä»¶æ‹·è´" class="headerlink" title="å¤§æ–‡ä»¶æ‹·è´"></a>å¤§æ–‡ä»¶æ‹·è´</h3><pre><code>var fs = require(â€˜fsâ€™);
function copy(src,dst){
    fs.createReadStream(src).pipe(fs.createWriteStream(dst));
}
function main(argv){
    copy(argv[0],argv[1]);
}
main(process.argv.slice(2));
</code></pre><p><code>pipe</code>æ–¹æ³•æŠŠä¸¤ä¸ªæ•°æ®æµè¿æ¥äº†èµ·æ¥ï¼Œæ°´é¡ºç€æ°´ç®¡ä»ä¸€ä¸ªæ¡¶æµåˆ°å¦ä¸€ä¸ªæ¡¶ã€‚</p>
<h2 id="API-èµ°é©¬è§‚èŠ±"><a href="#API-èµ°é©¬è§‚èŠ±" class="headerlink" title="API èµ°é©¬è§‚èŠ±"></a>API èµ°é©¬è§‚èŠ±</h2><h3 id="Bufferï¼ˆæ•°æ®å—ï¼‰"><a href="#Bufferï¼ˆæ•°æ®å—ï¼‰" class="headerlink" title="Bufferï¼ˆæ•°æ®å—ï¼‰"></a>Bufferï¼ˆæ•°æ®å—ï¼‰</h3><p>NodeJs æä¾›ä¸€ä¸ªä¸<code>String</code>å¯¹ç­‰çš„å…¨å±€æ„é€ å‡½æ•°<code>Buffer</code>æä¾›å¯¹äºŒè¿›åˆ¶æ•°æ®çš„æ“ä½œã€‚</p>
<pre><code>var bin = new Buffer([0x68, 0x65, 0x6c, 0x6c, 0x6f]);
bin[0];    // =&gt; 0x68;
var str = bin.toString(â€˜utf-8â€™);    // =&gt; â€œhelloâ€
var bin = new Buffer(â€˜helloâ€™,â€™utf-8â€™);    // =&gt; &lt;Buffer 68 65 6c 6c 6f&gt;
</code></pre><p>å­—ç¬¦ä¸²æ˜¯åªè¯»çš„ï¼Œå¯¹å­—ç¬¦ä¸²çš„ä»»ä½•ä¿®æ”¹å¾—åˆ°ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ã€‚<code>Buffer</code>æ›´åƒæ˜¯åšæŒ‡é’ˆæ“ä½œçš„ C è¯­è¨€æ•°ç»„ï¼Œå¯¹<code>Buffer</code>çš„ä¿®æ”¹ä½œç”¨äºåŸ<code>Buffer</code>ï¼›å¦‚æœæƒ³æ‹·è´ä¸€ä»½<code>Buffer</code>ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°<code>Buffer</code>ï¼Œå¹¶é€šè¿‡<code>.copy</code>æ–¹æ³•å¤åˆ¶åŸ<code>Buffer</code>ä¸­çš„æ•°æ®ã€‚</p>
<h3 id="Streamï¼ˆæ•°æ®æµï¼‰"><a href="#Streamï¼ˆæ•°æ®æµï¼‰" class="headerlink" title="Streamï¼ˆæ•°æ®æµï¼‰"></a>Streamï¼ˆæ•°æ®æµï¼‰</h3><p>ä»¥å¤§æ–‡ä»¶æ‹·è´ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ•°æ®æ¥æºåˆ›å»ºä¸€ä¸ªæ•°æ®æµ</p>
<pre><code>var rs = fs.createReadStream(pathname);
rs.on(â€˜dataâ€™,function(chunk){
    doSomething(chunk);
});
rs.on(â€˜endâ€™,function(){
    cleanUp();
});
</code></pre><p>ä»¥ä¸Š<code>data</code>äº‹ä»¶ä¼šæºæºä¸æ–­è¢«è§¦å‘ï¼Œä¸ç®¡<code>doSomething</code>å‡½æ•°æ˜¯å¦å¤„ç†å¾—æ¥ã€‚ç»§ç»­æ”¹é€ ï¼š</p>
<pre><code>var rs = fs.createReadFileStream(src);
rs.on(â€˜dataâ€™,function(chunk){
    rs.pause();
    doSomething(chunk,function(){
        rs.resume();    //ç»™ doSomething åŠ äº†å›è°ƒ
    });
});
rs.on(â€˜endâ€™,function(){
    cleanUp();
});
</code></pre><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºæ•°æ®ç›®æ ‡åˆ›å»ºä¸€ä¸ªæ•°æ®æµï¼š</p>
<pre><code>var rs = fs.createReadStream(src);
var ws = fs.createWriteStream(dst);
rs.on(â€˜dataâ€™,function(chunk){
    if(ws.write(chunk) === false){
        rs.pause();
    }
});
rs.on(â€˜endâ€™,function(){
    ws.end();
});
ws.on(â€˜drainâ€™,function(){
    rs.resume();
});
</code></pre><p>ä»¥ä¸Šå®ç°äº†æ•°æ®ä»åªè¯»æ•°æ®æµåˆ°åªå†™æ•°æ®æµçš„æ¬è¿ï¼Œå¹¶åŒ…æ‹¬é˜²çˆ†ä»“æ§åˆ¶ã€‚</p>
<h3 id="File-Systemï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰"><a href="#File-Systemï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰" class="headerlink" title="File Systemï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰"></a>File Systemï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰</h3><p><code>fs</code>æ¨¡å—æä¾›çš„ API åŸºæœ¬åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>æ–‡ä»¶å±æ€§è¯»å†™ï¼š<code>fs.stat,fs.chmod,fs.chown</code></li>
<li>æ–‡ä»¶å†…å®¹è¯»å†™<code>fs.readFile,fs.readdir,fs.writeFile,fs.mkdir</code></li>
<li>åº•å±‚æ–‡ä»¶æ“ä½œ<code>fs.open,fs.read,fs.write,fs.close</code></li>
</ul>
<p><strong>å¼‚æ­¥ IO æ¨¡å‹</strong>ï¼šè¿™äº› API éƒ½é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’ç»“æœ</p>
<pre><code>fs.readFile(pathname,function(err,data){
    if(err){
        //Deal with the error.
    } else {
        //Deal with data.
    }
});
</code></pre><p>æ­¤å¤–ï¼Œ<code>fs</code>æ¨¡å—çš„å¼‚æ­¥ API éƒ½æœ‰å¯¹åº”çš„åŒæ­¥ç‰ˆæœ¬ï¼ŒåŒäºæ— æ³•ä½¿ç”¨å¼‚æ­¥æ“ä½œæˆ–åŒæ­¥æ›´æ–¹ä¾¿æ—¶çš„æƒ…å†µã€‚</p>
<pre><code>try{
    var data = fs.readFileSync(pathname);
    //Deal with data.
} catch(err){
    //Deal with error.
}
</code></pre><h3 id="Path-è·¯å¾„"><a href="#Path-è·¯å¾„" class="headerlink" title="Path(è·¯å¾„)"></a>Path(è·¯å¾„)</h3><ul>
<li>path.normalize</li>
<li>path.join</li>
<li>path.extname</li>
</ul>
<h2 id="éå†ç›®å½•"><a href="#éå†ç›®å½•" class="headerlink" title="éå†ç›®å½•"></a>éå†ç›®å½•</h2><h3 id="é€’å½’ç®—æ³•"><a href="#é€’å½’ç®—æ³•" class="headerlink" title="é€’å½’ç®—æ³•"></a>é€’å½’ç®—æ³•</h3><p>éå†ç›®å½•æ—¶ä¸€èˆ¬ä½¿ç”¨é€’å½’ç®—æ³•ï¼Œå¦åˆ™å°±éš¾ä»¥ç¼–å†™å‡ºç®€æ´çš„ä»£ç ã€‚é€’å½’ç®—æ³•ä¸æ•°å­¦å½’çº³æ³•ç±»ä¼¼ï¼Œé€šè¿‡ä¸æ–­ç¼©å°é—®é¢˜çš„è§„æ¨¡æ¥è§£å†³é—®é¢˜ã€‚</p>
<pre><code>function factorial(n){
    if(n===1){
        return 1;
    } else {
        return n*factorial(n-1);
    }
}
</code></pre><blockquote>
<p>ä½¿ç”¨é€’å½’ç®—æ³•ç¼–å†™çš„ä»£ç è™½ç„¶ç®€æ´ï¼Œä½†ç”±äºæ¯é€’å½’ä¸€æ¬¡å°±äº§ç”Ÿä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œåœ¨éœ€è¦ä¼˜å…ˆè€ƒè™‘æ€§èƒ½æ—¶ï¼Œéœ€è¦æŠŠé€’å½’ç®—æ³•è½¬æ¢ä¸ºå¾ªç¯ç®—æ³•ï¼Œä»¥å‡å°‘å‡½æ•°è°ƒç”¨æ¬¡æ•°ã€‚</p>
</blockquote>
<h3 id="éå†ç®—æ³•"><a href="#éå†ç®—æ³•" class="headerlink" title="éå†ç®—æ³•"></a>éå†ç®—æ³•</h3><p>ç›®å½•æ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œåœ¨éå†æ—¶ä¸€èˆ¬ä½¿ç”¨æ·±åº¦ä¼˜å…ˆ+å…ˆåºéå†ç®—æ³•ã€‚æ·±åº¦ä¼˜å…ˆï¼Œæ„å‘³ç€åˆ°è¾¾ä¸€ä¸ªèŠ‚ç‚¹åï¼Œé¦–å…ˆæ¥ç€éå†å­èŠ‚ç‚¹è€Œä¸æ˜¯é‚»å±…èŠ‚ç‚¹ã€‚å…ˆåºéå†ï¼Œæ„å‘³ç€é¦–æ¬¡åˆ°è¾¾äº†æŸèŠ‚ç‚¹å°±ç®—éå†å®Œæˆï¼Œè€Œä¸æ˜¯æœ€åä¸€æ¬¡è¿”å›æŸèŠ‚ç‚¹æ‰ç®—æ•°ã€‚å› æ­¤ä½¿ç”¨è¿™ç§éå†æ–¹å¼æ—¶ï¼Œä¸‹è¾¹è¿™æ£µæ ‘çš„éå†é¡ºåºæ˜¯ <code>A&gt;B&gt;D&gt;E&gt;C&gt;F</code></p>
<pre><code>          A
         / \
        B   C
       / \   \
      D   E   F
</code></pre><h3 id="åŒæ­¥éå†"><a href="#åŒæ­¥éå†" class="headerlink" title="åŒæ­¥éå†"></a>åŒæ­¥éå†</h3><pre><code>function travel(dir,callback){
    fs.readdirSync(dir).forEach(function(file){
        var pathname = path.join(dir,file);
        if(fs.statSync(pathname).isDirectory()){
        travel(pathname,callback);
        } else {
            callback(pathname);
        }
    });
}
</code></pre><p>è¯¥å‡½æ•°ä»¥æŸä¸ªç›®å½•ä½œä¸ºéå†èµ·ç‚¹ï¼Œé‡åˆ°ä¸€ä¸ªå­ç›®å½•æ—¶ï¼Œå°±å…ˆæ¥ç€éå†å­ç›®å½•ã€‚é‡åˆ°ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå°±æŠŠæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¼ ç»™å›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°æ‹¿åˆ°æ–‡ä»¶è·¯å¾„åï¼Œå°±å¯ä»¥åšå„ç§åˆ¤æ–­å’Œå¤„ç†ã€‚</p>
<pre><code>- /home/user/
    - foo/
        x.js
    - bar/
        y.js
    z.css
</code></pre><p>ä½¿ç”¨ä¸€ä¸‹ä»£ç éå†è¯¥ç›®å½•æ—¶ï¼Œå¾—åˆ°è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code>travel(â€˜/home/userâ€™,function(pathname){
    console.log(pathname);
});

---------------------
/home/user/foo/x.js
/home/user/bar/y.js
/home/user/z.css
</code></pre><h3 id="å¼‚æ­¥éå†"><a href="#å¼‚æ­¥éå†" class="headerlink" title="å¼‚æ­¥éå†"></a>å¼‚æ­¥éå†</h3><p><code>travel</code>å‡½æ•°çš„å¼‚æ­¥ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p>
<pre><code>function travel(dir,callback,finish){
    fs.readdir(dir,function(err,files){
        (function next(i){
            if(i&lt;files.length){
                var pathname = path.join(dir,files[i]);
                fs.stat(pathname,function(err,stats){
                    if(stats.isDirectory()){
                        travel(pathname,callback,function(){
                            next(i+1);
                        });
                    } else {
                        callback(pathname,function(){
                            next(i+1);
                        });
                    }
                });
            } else {
                finish &amp;&amp; finish();
            }
        }(0));
    });
}
</code></pre><h2 id="æ–‡æœ¬ç¼–ç "><a href="#æ–‡æœ¬ç¼–ç " class="headerlink" title="æ–‡æœ¬ç¼–ç "></a>æ–‡æœ¬ç¼–ç </h2><p>åœ¨è¯»å–ä¸åŒç¼–ç çš„æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œéœ€è¦å°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸º JS ä½¿ç”¨çš„<code>UTF8</code>ç¼–ç å­—ç¬¦ä¸²åæ‰èƒ½æ­£å¸¸å¤„ç†</p>
<h3 id="BOMçš„ç§»é™¤"><a href="#BOMçš„ç§»é™¤" class="headerlink" title="BOMçš„ç§»é™¤"></a><em>BOM</em>çš„ç§»é™¤</h3><p>BOM ç”¨äºæ ‡è®°ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ä½¿ç”¨ Unicode ç¼–ç ï¼Œå…¶æœ¬èº«æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦(â€œ\uFEFFâ€) ï¼Œä½äºæ–‡æœ¬æ–‡ä»¶å¤´éƒ¨ã€‚<br>ä½¿ç”¨ NodeJS è¯»å–æ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œä¸€èˆ¬éœ€è¦å»æ‰ BOM:</p>
<pre><code>function readText(pathname){
    var bin = fs.readFileSync(pathname);
    if(bin[0] === 0xEF &amp;&amp; bin[1] === 0xBB &amp;&amp; bin[2] === 0xBF){
        bin = bin.slice(3);
    }
    return bin.toString(â€˜utf-8â€™);
}
</code></pre><h3 id="GBK-è½¬-UTF8"><a href="#GBK-è½¬-UTF8" class="headerlink" title="GBK è½¬ UTF8"></a>GBK è½¬ UTF8</h3><p>ä¸€èˆ¬å€ŸåŠ©<code>iconv-lite</code>è¿™ä¸ªä¸‰æ–¹åŒ…æ¥è½¬æ¢ç¼–ç ã€‚</p>
<pre><code>var iconv = require(â€˜iconv-liteâ€™);
function readGBKText(pathname){
    var bin = fs.readFileSync(pathname);
    return iconv.decode(bin,â€™gbkâ€™);
}
</code></pre><h3 id="å•å­—èŠ‚ç¼–ç "><a href="#å•å­—èŠ‚ç¼–ç " class="headerlink" title="å•å­—èŠ‚ç¼–ç "></a>å•å­—èŠ‚ç¼–ç </h3><p>å³ä½¿æ–‡æœ¬æ–‡ä»¶ä¸­æœ‰ä¸­æ–‡ç­‰å­—ç¬¦ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¤„ç†çš„å­—ç¬¦ä»…åœ¨ ASCII0~128 èŒƒå›´ï¼Œæ¯”å¦‚é™¤äº†æ³¨é‡Šå’Œå­—ç¬¦ä¸²ä»¥å¤–çš„ JS ä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»Ÿä¸€ä½¿ç”¨å•å­—èŠ‚ç¼–ç æ¥è¯»å–æ–‡ä»¶ï¼Œä¸ç”¨å…³å¿ƒæ–‡ä»¶çš„å®é™…ç¼–ç æ˜¯ GBK è¿˜æ˜¯ UTF8</p>
<pre><code>1. GBKç¼–ç æºå†…å®¹ï¼š
    var foo = â€˜ä¸­æ–‡â€˜ï¼›
2. å¯¹åº”å­—èŠ‚ï¼š
    76 61 72 20 66 6F 6F 20 3D 20 3D 20 27 D6 D0 CE C4 27 3B
3. ä½¿ç”¨å•å­—èŠ‚ç¼–ç è¯»å–åå¾—åˆ°å†…å®¹ï¼š
    var foo = &#39;{ä¹±ç }{ä¹±ç }{ä¹±ç }{ä¹±ç }&#39;;
4. æ›¿æ¢å†…å®¹ï¼š
    var bar = &#39;{ä¹±ç }{ä¹±ç }{ä¹±ç }{ä¹±ç }&#39;;
5. ä½¿ç”¨å•å­—èŠ‚ç¼–ç ä¿å­˜åå¯¹åº”å­—èŠ‚ï¼š
    76 61 72 20 62 61 72 20 3D 20 27 D6 D0 CE C4 27 3B
6. ä½¿ç”¨GBKç¼–ç è¯»å–åå¾—åˆ°å†…å®¹ï¼š
    var bar = &#39;ä¸­æ–‡&#39;;
</code></pre><p>è¯€çªåœ¨äºï¼Œä¸ç®¡å¤§äº 0xEF çš„å•ä¸ªå­—èŠ‚åœ¨å•å­—èŠ‚ç¼–ç ä¸‹è¢«è§£ææˆä»€ä¹ˆä¹±ç å­—ç¬¦ï¼Œä½¿ç”¨åŒæ ·çš„å•å­—èŠ‚ç¼–ç ä¿å­˜è¿™äº›ä¹±ç å­—ç¬¦æ—¶ï¼ŒèƒŒåå¯¹åº”çš„å­—èŠ‚ä¿æŒä¸å˜ã€‚</p>
<h1 id="ç½‘ç»œæ“ä½œ"><a href="#ç½‘ç»œæ“ä½œ" class="headerlink" title="ç½‘ç»œæ“ä½œ"></a>ç½‘ç»œæ“ä½œ</h1><h2 id="http-æ¨¡å—"><a href="#http-æ¨¡å—" class="headerlink" title="http æ¨¡å—"></a><code>http</code> æ¨¡å—</h2><p>ä½¿ç”¨ NodeJs å†…ç½®çš„<code>http</code>æ¨¡å—ç®€å•å®ç° HTTP æœåŠ¡å™¨</p>
<pre><code>var http = require(â€˜httpâ€™);
http.createServer(function(request,response){
    response.writeHead(2000,{â€˜Content-Typeâ€™:â€™text-plainâ€™});
    response.end(â€˜Hello World\nâ€™);
}).listen(8124);
</code></pre><p>ä»¥ä¸Šç¨‹åºåˆ›å»ºäº†ä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶ç›‘å¬<code>8124</code>ç«¯å£ï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®è¯¥ç«¯å£<code>http://127.0.0.1:8124/</code>å°±èƒ½å¤Ÿçœ‹åˆ°æ•ˆæœã€‚</p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p><code>http</code>æ¨¡å—æä¾›ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>ä½œä¸ºæœåŠ¡ç«¯ä½¿ç”¨æ—¶ï¼Œåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œç›‘å¬ HTTP å®¢æˆ·ç«¯è¯·æ±‚å¹¶è¿”å›å“åº”</li>
<li>ä½œä¸ºå®¢æˆ·ç«¯ä½¿ç”¨æ—¶ï¼Œå‘èµ·ä¸€ä¸ª HTTP å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè·å–æœåŠ¡ç«¯å“åº”.<br>æœåŠ¡ç«¯æ¨¡å¼ä¸‹ï¼Œé¦–å…ˆä½¿ç”¨<code>.createServer</code>æ–¹æ³•åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨ï¼Œç„¶åè°ƒç”¨<code>.listen</code>æ–¹æ³•ç›‘å¬ç«¯å£ã€‚ä¹‹åï¼Œæ¯ä¸€æ¬¡çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåˆ›å»ºæœåŠ¡å™¨ä¼ å…¥çš„å›è°ƒå‡½æ•°å°±è¢«è°ƒç”¨ä¸€æ¬¡ã€‚<br>HTTP è¯·æ±‚æœ¬è´¨ä¸Šæ˜¯æ•°æ®æµï¼Œç”±è¯·æ±‚å¤´ï¼ˆheaderï¼‰å’Œè¯·æ±‚ä½“ï¼ˆbodyï¼‰ç»„æˆã€‚</li>
</ul>
<pre><code>POST / HTTP/1.1
User-Agent: curl/7.26.0
Host: localhost
Accept: */*
Content-Length: 11
Content-Type: application/x-www-form-urlencoded

Hello World
</code></pre><p>åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨<code>request</code>å¯¹è±¡è®¿é—®è¯·æ±‚å¤´æ•°æ®å¤–ï¼Œè¿˜èƒ½æŠŠ<code>request</code>å¯¹è±¡å½“ä½œä¸€ä¸ªæ•°æ®æµæ¥è®¿é—®è¯·æ±‚ä½“æ•°æ®ã€‚</p>
<pre><code>http.createServer(function(request,response){
    var body = [];
    console.log(request.method);
    console.log(request.headers);

    request.on(â€˜dataâ€™,function(chunk){
        body.push(chunk);
    });
    request.on(â€˜endâ€™,function(){
        body = Buffer.concat(body);
        console.log(body.toString());
    });
}).listen(80);

---------------------------------
POST
{â€˜user-agentâ€™:â€™curl/7.26.0â€™,
    host:â€™localhostâ€™,
    accept:â€™*/*â€™,
    â€˜content-lengthâ€™:â€™11â€™,
    â€˜content-typeâ€™:â€™application/x-www-form-urlencodedâ€™}
Hello World
</code></pre><p>HTTP å“åº”æœ¬è´¨ä¸Šä¹Ÿæ˜¯æ•°æ®æµï¼ŒåŒæ ·ç”±å“åº”å¤´ï¼ˆheadersï¼‰å’Œå“åº”ä½“ï¼ˆbodyï¼‰ç»„æˆã€‚ä¾‹å¦‚è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ HTTP è¯·æ±‚æ•°æ®å†…å®¹ï¼š</p>
<pre><code>HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 11
Data: Tue, 05 Nov 2013 05:31:38 GMT
Connection: keep-alive

Hello World
</code></pre><p>åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œé™¤äº†å¯ä»¥ä½¿ç”¨<code>respond</code>å¯¹è±¡æ¥å†™å…¥å“åº”å¤´æ•°æ®å¤–ï¼Œè¿˜èƒ½æŠŠ<code>response</code>å¯¹è±¡å½“ä½œä¸€ä¸ªæ•°æ®æµæ¥å†™å…¥å“åº”ä½“æ•°æ®ã€‚ä¾‹å¦‚åœ¨ä»¥ä¸‹ä¾‹å­ä¸­ï¼ŒæœåŠ¡ç«¯åŸæ ·å°†å®¢æˆ·ç«¯è¯·æ±‚çš„è¯·æ±‚ä½“æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼š</p>
<pre><code>http.createServer(function(request,response){
    response.writeHead(200,{â€˜Content-Typeâ€™:â€™text/plainâ€™});
    request.on(â€˜dataâ€™,function(chunk){
        response.write(chunk);
    });
    request.on(â€˜endâ€™,function(){
        response.end();
    });
}).listen(80);
</code></pre><p>å®¢æˆ·ç«¯æ¨¡å¼ä¸‹ï¼Œä¸ºäº†å‘èµ·ä¸€ä¸ªå®¢æˆ·ç«¯ HTTP è¯·æ±‚ï¼Œéœ€è¦æŒ‡å®šç›®æ ‡æœåŠ¡å™¨çš„ä½ç½®å¹¶å‘é€è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“</p>
<pre><code>var options = {
    hostname: â€˜www.example.comâ€™,
    port: 80,
    path: â€˜/uploadâ€™,
    method: â€˜POSTâ€™,
    headers:{
        â€˜Content-Typeâ€™:â€™application/x-www-form-urlencodedâ€™
    }
};

var request = http.request(options,function(response){});

request.write(â€˜Hello Worldâ€™);
request.end();
</code></pre><p><code>.request</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¹¶åˆ¶å®šè¯·æ±‚ç›®æ ‡å’Œè¯·æ±‚å¤´æ•°æ®ã€‚ä¹‹åï¼Œå°±å¯ä»¥æŠŠ<code>request</code>å¯¹è±¡å½“ä½œä¸€ä¸ªæ•°æ®æµæ¥å†™å…¥è¯·æ±‚ä½“æ•°æ®å’Œç»“æŸè¯·æ±‚ã€‚å¦å¤–ï¼Œç”±äº HTTP è¯·æ±‚ä¸­<code>GET</code>è¯·æ±‚æ˜¯æœ€å¸¸è§çš„ä¸€ç§ï¼Œä¸”ä¸éœ€è¦è¯·æ±‚ä½“ï¼Œå› æ­¤<code>http</code>æ¨¡å—ä¹Ÿæä¾›äº†ä¾¿æ· APIï¼š<br><code>http.get(â€˜http://www.example.com/â€˜,function(response){});</code><br>å½“å®¢æˆ·ç«¯å‘é€è¯·æ±‚å¹¶æ¥æ”¶åˆ°å®Œæ•´çš„æœåŠ¡ç«¯å“åº”å¤´æ—¶ï¼Œå°±ä¼šè°ƒç”¨å›è°ƒå‡½æ•°ã€‚åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œè¿˜èƒ½æŠŠ<code>response</code>å¯¹è±¡å½“ä½œä¸€ä¸ªåªè¯»æ•°æ®æµæ¥è®¿é—®å“åº”ä½“æ•°æ®</p>
<pre><code>http.get(â€˜http://www.example.com/â€˜,function(response){
    var body = [];
    console.log(response.statusCode);
    console.log(response.headers);
    response.on(â€˜dataâ€™,function(chunk){
        body.push(chunk);
    });
    response.on(â€˜endâ€™,function(){
        body = Buffer.concat(body);
        console.log(body.toString());
    });
});

---------------------------------
200
{â€˜content-typeâ€™:â€™text/htmlâ€™,
    server:â€™Apacheâ€™,
    â€˜content-lengthâ€™:â€™801â€™,
    data:â€™Tue, 05 Nov 2013 06:08:41 GMTâ€™,
    connection: â€˜keep-aliveâ€™}
&lt;!DOCTYPE html&gt;
...
</code></pre><h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p><code>https</code>æ¨¡å—éœ€è¦é¢å¤–å¤„ç† SSL è¯ä¹¦ã€‚<br>åœ¨æœåŠ¡ç«¯æ¨¡å¼ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼š</p>
<pre><code>var options = {
    key: fs.readFileSync(â€˜./ssl/default.keyâ€™),
    cert: fs.readFileSync(â€˜./ssl/default.cerâ€™)
};
</code></pre><h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><pre><code>                                href
---------------------------------------------------------------
                            host              path
                      --------------- -------------------------
http: // user:pass @ host.com : 8080 /p/a/t/h ?query=string #hash
-----    ---------   --------   ---- -------- ------------- -----
protocol     auth     hostname   port pathname     search     hash
                                                ------------
                                                   query
</code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>.parse</code>æ–¹æ³•æ¥å°†ä¸€ä¸ª URL å­—ç¬¦ä¸²è½¬æ¢ä¸º URL å¯¹è±¡ï¼š</p>
<pre><code>url.parse(&#39;http://user:pass@host.com:8080/p/a/t/h?query=string#hash&#39;);
/* =&gt;
{ protocol: &#39;http:&#39;,
  auth: &#39;user:pass&#39;,
  host: &#39;host.com:8080&#39;,
  port: &#39;8080&#39;,
  hostname: &#39;host.com&#39;,
  hash: &#39;#hash&#39;,
  search: &#39;?query=string&#39;,
  query: &#39;query=string&#39;,
  pathname: &#39;/p/a/t/h&#39;,
  path: &#39;/p/a/t/h?query=string&#39;,
  href: &#39;http://user:pass@host.com:8080/p/a/t/h?query=string#hash&#39; }
*/
</code></pre><p>ä¼ ç»™<code>.parse</code>æ–¹æ³•çš„ä¸ä¸€å®šè¦æ˜¯ä¸€ä¸ªå®Œæ•´çš„ URLï¼Œä¾‹å¦‚åœ¨ HTTP æœåŠ¡å™¨å›è°ƒå‡½æ•°ä¸­ï¼Œ<code>request.url</code>ä¸åŒ…å«åè®®å¤´å’ŒåŸŸåï¼Œä½†åŒæ ·å¯ä»¥è§£æï¼š</p>
<pre><code>http.createServer(function (request, response) {
    var tmp = request.url; // =&gt; &quot;/foo/bar?a=b&quot;
    url.parse(tmp);
    /* =&gt;
    { protocol: null,
      slashes: null,
      auth: null,
      host: null,
      port: null,
      hostname: null,
      hash: null,
      search: &#39;?a=b&#39;,
      query: &#39;a=b&#39;,
      pathname: &#39;/foo/bar&#39;,
      path: &#39;/foo/bar?a=b&#39;,
      href: &#39;/foo/bar?a=b&#39; }
    */
}).listen(80);
</code></pre><p>åè¿‡æ¥ï¼Œ<code>format</code>æ–¹æ³•å…è®¸å°†ä¸€ä¸ª URL å¯¹è±¡è½¬æ¢ä¸º URL å­—ç¬¦ä¸²</p>
<pre><code>url.format({
    protocol: &#39;http:&#39;,
    host: &#39;www.example.com&#39;,
    pathname: &#39;/p/a/t/h&#39;,
    search: &#39;query=string&#39;
});
/* =&gt;
&#39;http://www.example.com/p/a/t/h?query=string&#39;
*/
</code></pre><p><code>.resolve</code>æ–¹æ³•å¯ä»¥ç”¨äºæ‹¼æ¥ URLï¼š</p>
<pre><code>url.resolve(&#39;http://www.example.com/foo/bar&#39;, &#39;../baz&#39;);
/* =&gt;
http://www.example.com/baz
*/
</code></pre><h3 id="Query-String"><a href="#Query-String" class="headerlink" title="Query String"></a>Query String</h3><p><code>querystring</code>æ¨¡å—ç”¨äºå®ç° URL å‚æ•°å­—ç¬¦ä¸²ä¸å‚æ•°å¯¹è±¡çš„äº’ç›¸è½¬æ¢</p>
<pre><code>querystring.parse(&#39;foo=bar&amp;baz=qux&amp;baz=quux&amp;corge&#39;);
/* =&gt;
{ foo: &#39;bar&#39;, baz: [&#39;qux&#39;, &#39;quux&#39;], corge: &#39;&#39; }
*/

querystring.stringify({ foo: &#39;bar&#39;, baz: [&#39;qux&#39;, &#39;quux&#39;], corge: &#39;&#39; });
/* =&gt;
&#39;foo=bar&amp;baz=qux&amp;baz=quux&amp;corge=&#39;
*/
</code></pre><h3 id="Zlib"><a href="#Zlib" class="headerlink" title="Zlib"></a>Zlib</h3><p><code>zlib</code>æ¨¡å—æä¾›äº†æ•°æ®å‹ç¼©å’Œè§£å‹çš„åŠŸèƒ½ã€‚</p>
<p>è¿™ä¸ªä¾‹å­åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒ gzipï¼Œæ”¯æŒåˆ™ä½¿ç”¨<code>zlib</code>è¿”å› gzip åçš„å“åº”ä½“æ•°æ®</p>
<pre><code>http.createServer(function (request, response) {
    var i = 1024,
        data = &#39;&#39;;

    while (i--) {
        data += &#39;.&#39;;
    }

    if ((request.headers[&#39;accept-encoding&#39;] || &#39;&#39;).indexOf(&#39;gzip&#39;) !== -1) {
        zlib.gzip(data, function (err, data) {
            response.writeHead(200, {
                &#39;Content-Type&#39;: &#39;text/plain&#39;,
                &#39;Content-Encoding&#39;: &#39;gzip&#39;
            });
            response.end(data);
        });
    } else {
        response.writeHead(200, {
            &#39;Content-Type&#39;: &#39;text/plain&#39;
        });
        response.end(data);
    }
}).listen(80);
</code></pre><p>è§£å‹å“åº”ä½“æ•°æ®</p>
<pre><code>var options = {
        hostname: &#39;www.example.com&#39;,
        port: 80,
        path: &#39;/&#39;,
        method: &#39;GET&#39;,
        headers: {
            &#39;Accept-Encoding&#39;: &#39;gzip, deflate&#39;
        }
    };

http.request(options, function (response) {
    var body = [];

    response.on(&#39;data&#39;, function (chunk) {
        body.push(chunk);
    });

    response.on(&#39;end&#39;, function () {
        body = Buffer.concat(body);

        if (response.headers[&#39;content-encoding&#39;] === &#39;gzip&#39;) {
            zlib.gunzip(body, function (err, data) {
                console.log(data.toString());
            });
        } else {
            console.log(data.toString());
        }
    });
}).end();
</code></pre><h1 id="è¿›ç¨‹ç®¡ç†"><a href="#è¿›ç¨‹ç®¡ç†" class="headerlink" title="è¿›ç¨‹ç®¡ç†"></a>è¿›ç¨‹ç®¡ç†</h1><p>ä½¿ç”¨ NodeJS è°ƒç”¨ç»ˆç«¯å‘½ä»¤æ¥ç®€åŒ–ç›®å½•æ‹·è´ï¼š</p>
<pre><code>var child_process = require(â€˜child_processâ€™);
var util = require(â€˜utilâ€™);

function copy(source,target,callback){
    child_process.exec(
        util.format(â€˜cp -r  %s/* %sâ€™,source,targe),callback);
}

copy(â€˜aâ€™,â€™bâ€™,function(err){
    //...
});
</code></pre><p>å­è¿›ç¨‹å¼‚æ­¥è¿è¡Œï¼Œé€šè¿‡å›è°ƒå‡½æ•°è¿”å›æ‰§è¡Œç»“æœã€‚</p>
<h2 id="API-1"><a href="#API-1" class="headerlink" title="API"></a>API</h2><h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><p>åœ¨ NodeJS ä¸­ï¼Œå¯ä»¥é€šè¿‡<code>process</code>å…¨å±€å¯¹è±¡æ„ŸçŸ¥å’Œæ§åˆ¶ NodeJS è‡ªèº«è¿›ç¨‹çš„æ–¹æ–¹é¢é¢ã€‚</p>
<h3 id="Child-Process"><a href="#Child-Process" class="headerlink" title="Child Process"></a>Child Process</h3><p>ä½¿ç”¨è¯¥æ¨¡å—å¯ä»¥åˆ›å»ºå’Œæ§åˆ¶å­è¿›ç¨‹</p>
<h3 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h3><p><code>cluster</code>æ¨¡å—æ˜¯å¯¹<code>child_process</code>æ¨¡å—çš„è¿›ä¸€æ­¥å°è£…ï¼Œä¸“ç”¨è§£å†³å•è¿›ç¨‹ NodeJS Web æœåŠ¡å™¨æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„é—®é¢˜</p>
<h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><h3 id="å¦‚ä½•è·å–å‘½ä»¤è¡Œå‚æ•°"><a href="#å¦‚ä½•è·å–å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="å¦‚ä½•è·å–å‘½ä»¤è¡Œå‚æ•°"></a>å¦‚ä½•è·å–å‘½ä»¤è¡Œå‚æ•°</h3><pre><code>function main(argv){
    //...
}
main(process.argv.slice(2));
</code></pre><h3 id="å¦‚ä½•é€€å‡ºç¨‹åº"><a href="#å¦‚ä½•é€€å‡ºç¨‹åº" class="headerlink" title="å¦‚ä½•é€€å‡ºç¨‹åº"></a>å¦‚ä½•é€€å‡ºç¨‹åº</h3><pre><code>try{
    //...
} catch (err){
    //...
    process.exit(1);
}
</code></pre><h3 id="å¦‚ä½•æ§åˆ¶è¾“å…¥è¾“å‡º"><a href="#å¦‚ä½•æ§åˆ¶è¾“å…¥è¾“å‡º" class="headerlink" title="å¦‚ä½•æ§åˆ¶è¾“å…¥è¾“å‡º"></a>å¦‚ä½•æ§åˆ¶è¾“å…¥è¾“å‡º</h3><p>NodeJS ç¨‹åºçš„æ ‡å‡†è¾“å…¥æµ(stdin)ã€ä¸€ä¸ªæ ‡å‡†è¾“å‡ºæµ(stout)ã€ä¸€ä¸ªæ ‡å‡†é”™è¯¯æµ(stderr)åˆ†åˆ«å¯¹åº”<code>process.stdin</code>ã€<code>process.stdout</code>ã€<code>process.stderr</code>. å¯¹å®ƒä»¬çš„æ“ä½œæŒ‰ç…§å¯¹æ•°æ®æµçš„æ“ä½œæ–¹å¼å³å¯ã€‚<code>console.log</code>å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼å®ç°ï¼š</p>
<pre><code>function log(){
    process.stdout.write(
        util.format.apply(util,arguments)+â€™\nâ€™);
}
</code></pre><h3 id="å¦‚ä½•é™æƒ"><a href="#å¦‚ä½•é™æƒ" class="headerlink" title="å¦‚ä½•é™æƒ"></a>å¦‚ä½•é™æƒ</h3><p>åœ¨ Linux ä¸‹ï¼Œéœ€è¦ root æƒé™æ‰èƒ½ç›‘å¬ 1024 ä»¥ä¸‹ç«¯å£ï¼Œä¸€æ—¦ç«¯å£ç›‘å¬å®Œæˆï¼Œç»§ç»­è®©ç¨‹åºè¿è¡Œåœ¨ root æƒé™ä¸‹å­˜åœ¨å®‰å…¨éšæ‚£ï¼Œéœ€è¦é™æƒï¼š</p>
<pre><code>http.createServer(callback).listen(80,function(){
    var never = process.env,
        uid = parseInt(env[â€˜SUDO_UIDâ€™] || process.getuid(),10),
        gid = parseInt(env[env[â€˜SUDO_GIDâ€™]] || process.getgid(), 10);

    process.setgid(gid);
    process.setuid(uid);
});
</code></pre><h3 id="å¦‚ä½•åˆ›å»ºå­è¿›ç¨‹"><a href="#å¦‚ä½•åˆ›å»ºå­è¿›ç¨‹" class="headerlink" title="å¦‚ä½•åˆ›å»ºå­è¿›ç¨‹"></a>å¦‚ä½•åˆ›å»ºå­è¿›ç¨‹</h3><pre><code>var child = child_process.spawn(â€˜nodeâ€™,[â€˜xxx.js]);

child.stdout.on(â€˜dataâ€™,function(data){
    console.log(â€˜stdout: â€˜ + data);
});

child.stderr.on(â€˜dataâ€™,function(data){
    console.log(â€˜stderr: â€™ + data);
});

child.on(â€˜closeâ€™,function(code){
    console.log(â€˜child process exited with code â€˜ + code);
});
</code></pre><p><code>.spawn(exec,args,options)</code>æ–¹æ³•æ”¯æŒä¸‰ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ•°ç»„ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½æŒ‰é¡ºåºå¯¹åº”ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å¯é€‰ç”¨äºé…ç½®å­è¿›ç¨‹çš„æ‰§è¡Œç¯å¢ƒä¸è¡Œä¸ºã€‚</p>
<h3 id="è¿›ç¨‹é—´å¦‚ä½•é€šè®¯"><a href="#è¿›ç¨‹é—´å¦‚ä½•é€šè®¯" class="headerlink" title="è¿›ç¨‹é—´å¦‚ä½•é€šè®¯"></a>è¿›ç¨‹é—´å¦‚ä½•é€šè®¯</h3><pre><code>/* parent.js*/
var child = child_process.spawn(â€˜nodeâ€™,[â€˜child.jsâ€™])

child.kill(â€˜SIGTERMâ€™);

/*child.js*/
process.on(â€˜SIGTERMâ€™,function(){
    cleanUp();
    process.exit(0);
});
</code></pre><p>çˆ¶è¿›ç¨‹é€šè¿‡<code>.kill</code>æ–¹æ³•å‘å­è¿›ç¨‹å‘é€<code>SIGTERM</code>ä¿¡å·ï¼Œå­è¿›ç¨‹ç›‘å¬<code>process</code>å¯¹è±¡çš„<code>SIGTERM</code>äº‹ä»¶å“åº”ä¿¡å·ã€‚</p>
<p>å¦‚æœçˆ¶å­è¿›ç¨‹éƒ½æ˜¯ NodeJS è¿›ç¨‹ï¼Œå°±å¯ä»¥é€šè¿‡ IPCï¼ˆè¿›ç¨‹é—´é€šè®¯ï¼‰åŒå‘ä¼ é€’æ•°æ®ã€‚</p>
<pre><code>/*parent.js*/
var child = child_process.spawn(â€˜nodeâ€™,[â€˜child.jsâ€™],{
    stdio:[0,1,2,â€™ipcâ€™]
});

child.on(â€˜messageâ€™,function(msg){
    console.log(msg);
});

child.send({hello:â€™helloâ€™});

/*child.js*/
process.on(â€˜messageâ€™,function(msg){
    msg.hello = msg.hello.toUpperCase();
    process.end(msg);
});
</code></pre><p>çˆ¶è¿›ç¨‹åœ¨åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œåœ¨<code>options.stdio</code>å­—æ®µä¸­é€šè¿‡<code>ipc</code>å¼€å¯äº†ä¸€æ¡ IPC é€šé“ï¼Œä¹‹åå°±å¯ä»¥ç›‘å¬å­è¿›ç¨‹å¯¹è±¡çš„<code>message</code>äº‹ä»¶æ¥æ”¶æ¥è‡ªå­è¿›ç¨‹çš„æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡<code>.send</code>æ–¹æ³•ç»™å­è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚åœ¨å­è¿›ç¨‹è¿™è¾¹ï¼Œå¯ä»¥åœ¨<code>process</code>å¯¹è±¡ä¸Šç›‘å¬<code>message</code>äº‹ä»¶æ¥æ”¶æ¥è‡ªçˆ¶è¿›ç¨‹çš„æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡<code>.send</code>æ–¹æ³•å‘çˆ¶è¿›ç¨‹å‘é€æ¶ˆæ¯ã€‚</p>
<h3 id="å¦‚ä½•å®ˆæŠ¤å­è¿›ç¨‹"><a href="#å¦‚ä½•å®ˆæŠ¤å­è¿›ç¨‹" class="headerlink" title="å¦‚ä½•å®ˆæŠ¤å­è¿›ç¨‹"></a>å¦‚ä½•å®ˆæŠ¤å­è¿›ç¨‹</h3><p>å®ˆæŠ¤è¿›ç¨‹ä¸€èˆ¬ç”¨äºç›‘æ§å·¥ä½œè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œåœ¨å·¥ä½œè¿›ç¨‹ä¸æ­£å¸¸é€€å‡ºæ—¶é‡å¯å·¥ä½œè¿›ç¨‹ï¼Œä¿éšœå…¶ä¸é—´æ–­è¿è¡Œï¼ŒğŸ‘‡ ä¸€ç§å®ç°æ–¹å¼ï¼š</p>
<pre><code>/* daemon.js*/
function spawn(mainModule){
    var worker = child_process.spawn(â€˜nodeâ€™,[mainModule]);
    worker.on(â€˜exitâ€™,function(code){
        if(code !== 0){
            spawn(mainModule);
        }
    });
}

spawn(â€˜worker.jsâ€™);
</code></pre><h1 id="å¼‚æ­¥ç¼–ç¨‹"><a href="#å¼‚æ­¥ç¼–ç¨‹" class="headerlink" title="å¼‚æ­¥ç¼–ç¨‹"></a>å¼‚æ­¥ç¼–ç¨‹</h1><h2 id="å›è°ƒ"><a href="#å›è°ƒ" class="headerlink" title="å›è°ƒ"></a>å›è°ƒ</h2><pre><code>setTimeout(function(){
    console.log(â€˜worldâ€™);
},1000);
console.log(â€˜Helloâ€™);

// outputs
hello
world
</code></pre><p>Js æœ¬èº«å•çº¿ç¨‹æ— æ³•å¼‚æ­¥æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¤ä¸º<code>setTimeout</code>è¿™ç±»ç”±è¿è¡Œç¯å¢ƒæä¾›çš„ç‰¹æ®Šå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå¹³è¡Œçº¿ç¨‹åç«‹å³è¿”å›ï¼Œè®© JS ä¸»è¿›ç¨‹å¯ä»¥æ¥ç€æ‰§è¡Œåç»­ä»£ç ï¼Œå¹¶åœ¨æ”¶åˆ°å¹³è¡Œè¿›ç¨‹çš„é€šçŸ¥åå†æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚è¿™ç±»å‡½æ•°è¿˜åŒ…æ‹¬ NodeJS æä¾›çš„<code>fs.readFile</code>ä¹‹ç±»å¼‚æ­¥ API</p>
<h2 id="ä»£ç è®¾è®¡æ¨¡å¼"><a href="#ä»£ç è®¾è®¡æ¨¡å¼" class="headerlink" title="ä»£ç è®¾è®¡æ¨¡å¼"></a>ä»£ç è®¾è®¡æ¨¡å¼</h2><h3 id="å‡½æ•°è¿”å›å€¼"><a href="#å‡½æ•°è¿”å›å€¼" class="headerlink" title="å‡½æ•°è¿”å›å€¼"></a>å‡½æ•°è¿”å›å€¼</h3><p>ä½¿ç”¨ä¸€ä¸ªå‡½æ•°è¾“å‡ºä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„è¾“å…¥æ˜¯å¸¸è§éœ€æ±‚<br><strong>åŒæ­¥æ–¹å¼</strong></p>
<pre><code>var output = fn1(fn2(â€˜inputâ€™));
// Do Something.
</code></pre><p>å¼‚æ­¥æ–¹å¼ï¼Œå‡½æ•°æ‰§è¡Œç»“æœä¸æ˜¯é€šè¿‡è¿”å›å€¼ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’ã€‚</p>
<pre><code>fn2(â€˜inputâ€™,function(output2){
    fn1(output2,function(output1){
        // Do Something.
    });
});
</code></pre><h3 id="éå†æ•°ç»„"><a href="#éå†æ•°ç»„" class="headerlink" title="éå†æ•°ç»„"></a>éå†æ•°ç»„</h3><p><strong>åŒæ­¥æ‰§è¡Œ</strong></p>
<pre><code>var len = arr.length,
    i = 0;
for(; i&lt;len; ++i){
    arr[i] = sync(arr[i]);
}

// All array items have processed.
</code></pre><p>å¦‚æœå‡½æ•°éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œä»¥ä¸Šä»£ç å°±æ— æ³•ä¿è¯å¾ªç¯ç»“æŸåæ‰€æœ‰æ•°ç»„æˆå‘˜éƒ½å¤„ç†å®Œæ¯•ã€‚å¦‚æœæ•°ç»„æˆå‘˜å¿…é¡»ä¸€ä¸ªæ¥ä¸€ä¸ªä¸²è¡Œå¤„ç†ï¼Œåˆ™ä¸€èˆ¬è¿™æ ·ç¼–å†™ï¼š</p>
<pre><code>(function next(i,len,callback){
    if(i&lt;len){
        async(arr[i],function(value){
            arr[i] = value;
            next(i+1,len,callback);
        });
    } else {
        callback();
    }
}(0,arr.length,function(){
    // All array items have processed.
}));
</code></pre><p>ä»¥ä¸Šä»£ç åœ¨å¼‚æ­¥å‡½æ•°æ‰§è¡Œä¸€æ¬¡å¹¶è¿”å›æ‰§è¡Œç»“æœåæ‰ä¼ å…¥ä¸‹ä¸€ä¸ªæ•°ç»„æˆå‘˜å¹¶å¼€å§‹ä¸‹ä¸€è½®æ‰§è¡Œï¼Œç›´åˆ°æ‰€æœ‰æ•°ç»„æˆå‘˜å¤„ç†å®Œæ¯•åï¼Œé€šè¿‡å›è°ƒçš„æ–¹å¼åç»­ä»£ç æ‰§è¡Œã€‚</p>
<p>å¦‚æœæ•°ç»„æˆå‘˜å¯ä»¥å¹¶è¡Œå¤„ç†ï¼Œä½†åç»­ä»£ç ä»ç„¶éœ€è¦æ‰€æœ‰æ•°ç»„æˆå‘˜å¤„ç†å®Œæ¯•åæ‰èƒ½æ‰§è¡Œï¼Œåˆ™å¼‚æ­¥ä»£ç ä¼šè°ƒæ•´æˆä»¥ä¸‹å½¢å¼ï¼š</p>
<pre><code>(function (i, len, count, callback){
    for(; i&lt;len; ++i){
        (function(i){
            async(arr[i],function(value){
                arr[i] = value;
                if(++count === len){
                    callback();
                }
            });
        }(i));
    }
}(0,arr.length,0,function(){
    // All array items have processed.
}));
</code></pre><p>ä¸å¼‚æ­¥ä¸²è¡Œéå†ç›¸æ¯”ï¼Œä»¥ä¸Šä»£ç å¹¶è¡Œå¤„ç†æ‰€æœ‰æ•°ç»„æˆå‘˜ï¼Œå¹¶é€šè¿‡è®¡æ•°å™¨å˜é‡æ¥åˆ¤æ–­æ˜¯å¦å…¨éƒ¨å¤„ç†å®Œæ¯•</p>
<h3 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h3><p>JS è‡ªèº«çš„å¼‚å¸¸å¤„ç†æœºåˆ¶<code>try...catch...</code>åªèƒ½ç”¨äºåŒæ­¥æ‰§è¡Œä»£ç </p>
<pre><code>function sync(fn){
    return fn();
}

try{
    sync(null);
    // Do something.
} catch (err) {
    console.log(â€˜Error: %sâ€™, err.message);
}

// outputs
Error: object is not a function
</code></pre><p>å¼‚å¸¸æ²¿ç€ä»£ç æ‰§è¡Œè·¯å¾„ä¸€ç›´å†’æ³¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ª<code>try</code>è¯­å¥è¢«æ•è·ã€‚<br>ç”±äºå¼‚æ­¥å‡½æ•°ä¼šæ‰“æ–­ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œå¼‚æ­¥å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä»¥åŠæ‰§è¡Œä¹‹åäº§ç”Ÿçš„å¼‚å¸¸å†’æ³¡åˆ°æ‰§è¡Œè·¯å¾„è¢«æ‰“æ–­çš„ä½ç½®æ—¶ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰é‡åˆ°<code>try</code>è¯­å¥ï¼Œå°±ä½œä¸ºå…¨å±€å¼‚å¸¸æŠ›å‡ºï¼š</p>
<pre><code>function async(fn,callback){
    // Code execution path breaks here.
    setTimeout(function(){
        callback(fn());
    },0);
}

try{
    async(null,function(data){
        // Do something.
    });
} catch (err) {
    console.log(â€˜Error: %sâ€™, err.message);
}

// outputs
...
TypeError: object is not a function
...
</code></pre><p>å› ä¸ºä»£ç æ‰§è¡Œè·¯å¾„è¢«æ‰“æ–­ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨å¼‚å¸¸å†’æ³¡åˆ°æ–­ç‚¹ä¹‹å‰ç”¨<code>try</code>è¯­å¥æ•è·å¼‚å¸¸ï¼Œå¹¶é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’è¢«æ•è·çš„å¼‚å¸¸ã€‚</p>
<pre><code>function async(fn,callback){
    // Code execution path breaks here.
    setTimeout(function(){
        try{
            callback(null,fn());
        } catch (err){
            callback(err);
        }
    }, 0);
}

async(null,function(err,data){
    if(err){
        console.log(â€˜Error: %sâ€™, err.message);
    } else {
        // Do something.
    }
});

// outputs
Error: object is not a function
</code></pre><p>NodeJS å‡ ä¹æ‰€æœ‰å¼‚æ­¥ API éƒ½è¿™æ ·è®¾è®¡ï¼Œå›è°ƒå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>err</code>.</p>
<p>å¦‚æœæ˜¯åŒæ­¥ä»£ç ï¼Œåªéœ€è¦åœ¨ä»£ç å…¥å£å†™ä¸€ä¸ª<code>try</code>è¯­å¥å°±èƒ½æ•è·æ‰€æœ‰å†’æ³¡ä¸Šæ¥çš„å¼‚å¸¸ï¼š</p>
<pre><code>function main() {
    // Do something.
    syncA();
    // Do something.
    syncB();
    // Do something.
    syncC();
}

try {
    main();
} catch (err) {
    // Deal with exception.
}
</code></pre><p>ä½†å¦‚æœæ˜¯å¼‚æ­¥ä»£ç ï¼Œæ¯æ¬¡å¼‚æ­¥å‡½æ•°è°ƒç”¨éƒ½ä¼šæ‰“æ–­ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œåªèƒ½é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’å¼‚å¸¸ã€‚äºæ˜¯å°±éœ€è¦åœ¨æ¯ä¸ªå›è°ƒå‡½æ•°åˆ¤æ–­æ˜¯å¦å¼‚å¸¸ã€‚è¿™æ ·å°±åŠ å‰§äº†ä»£ç çš„å¤æ‚åº¦ã€‚NodeJS æä¾›äº†ä¸€äº›è§£å†³æ–¹æ¡ˆã€‚</p>
<h2 id="åŸŸï¼ˆDomainï¼‰"><a href="#åŸŸï¼ˆDomainï¼‰" class="headerlink" title="åŸŸï¼ˆDomainï¼‰"></a>åŸŸï¼ˆDomainï¼‰</h2><p>ä¸€ä¸ªåŸŸå°±æ˜¯ä¸€ä¸ª JS è¿è¡Œç¯å¢ƒï¼Œåœ¨ä¸€ä¸ªåŸŸä¸­ï¼Œæ²¡æœ‰è¢«æ•è·çš„å¼‚å¸¸å°†ä½œä¸ºå…¨å±€å¼‚å¸¸è¢«æŠ›å‡ºã€‚NodeJS é€šè¿‡<code>process</code>å¯¹è±¡æä¾›äº†æ•è·å…¨å±€å¼‚å¸¸çš„æ–¹æ³•ï¼š</p>
<pre><code>process.on(â€˜uncaughtExceptionâ€™,function(err){
    console.log(â€˜Error: %sâ€™,err.message);
});

setTimeout(function(fn){
    fn();
});

// outputs
Error: undefined is not a function
</code></pre><p>å¯¹äºå¤§å¤šæ•°å¼‚å¸¸ï¼Œæˆ‘ä»¬å¸Œæœ›å°½æ—©æ•è·ï¼š</p>
<pre><code>function async(request, callback) {
    // Do something.
    asyncA(request, function (err, data) {
        if (err) {
            callback(err);
        } else {
            // Do something
            asyncB(request, function (err, data) {
                if (err) {
                    callback(err);
                } else {
                    // Do something
                    asyncC(request, function (err, data) {
                        if (err) {
                            callback(err);
                        } else {
                            // Do something
                            callback(null, data);
                        }
                    });
                }
            });
        }
    });
}

http.createServer(function (request, response) {
    async(request, function (err, data) {
        if (err) {
            response.writeHead(500);
            response.end();
        } else {
            response.writeHead(200);
            response.end(data);
        }
    });
});
</code></pre><p>ä¸ºäº†è®©ä»£ç å¥½çœ‹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œä½¿ç”¨<code>domain</code>æ¨¡å—åˆ›å»ºä¸€ä¸ªå­åŸŸï¼ˆJS å­è¿è¡Œç¯å¢ƒï¼‰ã€‚åœ¨å­åŸŸå†…è¿è¡Œçš„ä»£ç å¯éšæ„æŠ›å‡ºå¼‚å¸¸ã€‚è¿™äº›å¼‚å¸¸é€šè¿‡å­åŸŸå¯¹è±¡çš„<code>error</code>äº‹ä»¶ç»Ÿä¸€æ•è·</p>
<pre><code>function async(request, callback) {
    // Do something.
    asyncA(request, function (data) {
        // Do something
        asyncB(request, function (data) {
            // Do something
            asyncC(request, function (data) {
                // Do something
                callback(data);
            });
        });
    });
}

http.createServer(function (request, response) {
    var d = domain.create();

    d.on(&#39;error&#39;, function () {
        response.writeHead(500);
        response.end();
    });

    d.run(function () {
        async(request, function (data) {
            response.writeHead(200);
            response.end(data);
        });
    });
});
</code></pre><p>æˆ‘ä»¬ä½¿ç”¨<code>.create</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªå­åŸŸå¯¹è±¡ï¼Œå¹¶é€šè¿‡<code>.run</code>æ–¹æ³•è¿›å…¥éœ€è¦åœ¨å­åŸŸä¸­è¿è¡Œçš„ä»£ç çš„å…¥å£ç‚¹ã€‚</p>
<p></p></div><div class="share"><span>åˆ†äº«åˆ°</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=http://xhdnoah.github.io/2018/11/05/nodejs/%20Electronic Moon%20ä¸ƒå¤©å­¦ä¼š NodeJs" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2018/11/07/æ­£åˆ™è¡¨è¾¾å¼/" title="æ­£åˆ™è¡¨è¾¾å¼ç¬”è®°"><i class="fa fa-angle-double-left"></i>&nbsp;ä¸Šä¸€ç¯‡: æ­£åˆ™è¡¨è¾¾å¼ç¬”è®°</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2018/11/05/js-callback/" title="JavaScript åŒæ­¥ã€å¼‚æ­¥ã€å›è°ƒã€é—­åŒ…">ä¸‹ä¸€ç¯‡: JavaScript åŒæ­¥ã€å¼‚æ­¥ã€å›è°ƒã€é—­åŒ…&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2019&nbsp;<a target="_blank" href="http://xhdnoah.github.io" rel="noopener noreferrer">Noah Xu</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>